<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Tracking Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 3px; font-family: monospace; }
        button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        input { padding: 8px; margin: 5px; width: 300px; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <h1>QR Code Tracking Diagnostic Tool</h1>
    
    <div class="section">
        <h2>1. Test URL Lookup</h2>
        <p>Enter a short URL or QR code URL to test if it's in the database:</p>
        <input type="text" id="testUrl" placeholder="e.g., https://qr-generator-xxx.vercel.app/r/AbC123">
        <button onclick="testUrlLookup()">Test URL Lookup</button>
        <div id="urlLookupResult" class="log"></div>
    </div>

    <div class="section">
        <h2>2. List All QR Codes</h2>
        <button onclick="listAllQRCodes()">Load All QR Codes</button>
        <div id="qrCodesList" class="log"></div>
    </div>

    <div class="section">
        <h2>3. Test Scan Tracking</h2>
        <p>Enter a QR code ID to test scan increment:</p>
        <input type="text" id="testQRId" placeholder="QR Code ID from above">
        <button onclick="testScanIncrement()">Test Scan Increment</button>
        <div id="scanTestResult" class="log"></div>
    </div>

    <div class="section">
        <h2>4. Check Recent Scans</h2>
        <button onclick="checkRecentScans()">Check Recent Scans</button>
        <div id="recentScans" class="log"></div>
    </div>

    <div class="section">
        <h2>5. Manual URL Test</h2>
        <p>Test if a URL redirects properly:</p>
        <input type="text" id="manualUrl" placeholder="Short URL to test">
        <button onclick="testManualRedirect()">Test Redirect</button>
        <div id="manualTestResult" class="log"></div>
    </div>

    <script type="module">
        // Import Firebase
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs, doc, updateDoc, increment, query, where, orderBy, limit } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase config (replace with your actual config)
        const firebaseConfig = {
            apiKey: "AIzaSyBxGQqQqQqQqQqQqQqQqQqQqQqQqQqQqQ",
            authDomain: "qr-generator-5vkixxiuz.firebaseapp.com",
            projectId: "qr-generator-5vkixxiuz",
            storageBucket: "qr-generator-5vkixxiuz.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdefghijklmnop"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.testUrlLookup = async function() {
            const url = document.getElementById('testUrl').value;
            const resultDiv = document.getElementById('urlLookupResult');
            
            if (!url) {
                resultDiv.innerHTML = '<span class="error">Please enter a URL</span>';
                return;
            }

            try {
                resultDiv.innerHTML = 'üîç Searching for URL in database...';
                
                // Query for the URL
                const q = query(collection(db, 'qrCodes'), where('shortUrl', '==', url));
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    const doc = querySnapshot.docs[0];
                    const data = doc.data();
                    resultDiv.innerHTML = `
                        <span class="success">‚úÖ Found QR Code!</span><br>
                        <strong>ID:</strong> ${doc.id}<br>
                        <strong>Original URL:</strong> ${data.originalUrl}<br>
                        <strong>Short URL:</strong> ${data.shortUrl}<br>
                        <strong>Full URL:</strong> ${data.fullUrl}<br>
                        <strong>Scan Count:</strong> ${data.scanCount || 0}<br>
                        <strong>UTM Source:</strong> ${data.utmSource}<br>
                        <strong>UTM Medium:</strong> ${data.utmMedium}<br>
                        <strong>UTM Campaign:</strong> ${data.utmCampaign}<br>
                        <strong>Created:</strong> ${data.createdAt?.toDate?.() || 'Unknown'}
                    `;
                } else {
                    resultDiv.innerHTML = '<span class="error">‚ùå URL not found in database</span>';
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
            }
        };

        window.listAllQRCodes = async function() {
            const resultDiv = document.getElementById('qrCodesList');
            
            try {
                resultDiv.innerHTML = 'üìä Loading QR codes...';
                
                const q = query(collection(db, 'qrCodes'), orderBy('createdAt', 'desc'), limit(20));
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    let html = `<span class="success">üìä Found ${querySnapshot.size} QR codes:</span><br><br>`;
                    
                    querySnapshot.docs.forEach((doc, index) => {
                        const data = doc.data();
                        html += `
                            <strong>${index + 1}. ID:</strong> ${doc.id}<br>
                            <strong>Short URL:</strong> ${data.shortUrl}<br>
                            <strong>Scan Count:</strong> ${data.scanCount || 0}<br>
                            <strong>Created:</strong> ${data.createdAt?.toDate?.() || 'Unknown'}<br>
                            <hr>
                        `;
                    });
                    
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = '<span class="error">‚ùå No QR codes found in database</span>';
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
            }
        };

        window.testScanIncrement = async function() {
            const qrId = document.getElementById('testQRId').value;
            const resultDiv = document.getElementById('scanTestResult');
            
            if (!qrId) {
                resultDiv.innerHTML = '<span class="error">Please enter a QR Code ID</span>';
                return;
            }

            try {
                resultDiv.innerHTML = 'üîÑ Testing scan increment...';
                
                const docRef = doc(db, 'qrCodes', qrId);
                await updateDoc(docRef, {
                    scanCount: increment(1)
                });
                
                resultDiv.innerHTML = '<span class="success">‚úÖ Scan count incremented successfully!</span>';
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
            }
        };

        window.checkRecentScans = async function() {
            const resultDiv = document.getElementById('recentScans');
            
            try {
                resultDiv.innerHTML = 'üìà Checking recent scans...';
                
                const q = query(collection(db, 'qrCodeScans'), orderBy('timestamp', 'desc'), limit(10));
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    let html = `<span class="success">üìà Found ${querySnapshot.size} recent scans:</span><br><br>`;
                    
                    querySnapshot.docs.forEach((doc, index) => {
                        const data = doc.data();
                        html += `
                            <strong>${index + 1}. QR Code ID:</strong> ${data.qrCodeId}<br>
                            <strong>Timestamp:</strong> ${data.timestamp?.toDate?.() || 'Unknown'}<br>
                            <strong>User Agent:</strong> ${data.userAgent?.substring(0, 50)}...<br>
                            <hr>
                        `;
                    });
                    
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = '<span class="error">‚ùå No recent scans found</span>';
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
            }
        };

        window.testManualRedirect = async function() {
            const url = document.getElementById('manualUrl').value;
            const resultDiv = document.getElementById('manualTestResult');
            
            if (!url) {
                resultDiv.innerHTML = '<span class="error">Please enter a URL</span>';
                return;
            }

            try {
                resultDiv.innerHTML = 'üîÑ Testing redirect...';
                
                // Open the URL in a new tab
                window.open(url, '_blank');
                
                resultDiv.innerHTML = '<span class="success">‚úÖ Opened URL in new tab. Check if it redirects properly.</span>';
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
            }
        };
    </script>
</body>
</html> 